# Story 2.3: Language Preference Persistence

**Status:** Ready for Review

**Story**
**As a** tenant experience steward,
**I want** detected language to persist and update tenant preferences,
**so that** downstream workflows can communicate in the tenant’s preferred language.

**Acceptance Criteria**
1. On inbound message, update `conversation.language_detected` and `language_confidence`
2. If a tenant is associated, update tenant profile language preference via existing mechanism/API
3. If multiple messages provide conflicting signals, prefer most recent with higher confidence; record audit trail in logs
4. Language value persists across conversations for the same tenant (reuse last known unless stronger evidence arrives)
5. Tests simulate EN/ES/PT transitions and verify tenant profile updates are invoked appropriately

**Tasks / Subtasks**
- [x] Language detection component (AC: 1,3)
  - [x] Implement `LanguageDetector.detect(text) -> tuple[lang_code, confidence]` with simple EN/ES/PT heuristics; return `("unknown", 0.0)` when inconclusive [Source: docs/architecture/components.md#LanguageDetector]
  - [x] Unit tests for detection across EN/ES/PT phrases; include low-confidence scenarios [Source: docs/architecture/coding-standards.md#Test-Organization]
- [x] Inbound flow updates (AC: 1,3)
  - [x] Extend `SmsService.handle_inbound(...)` to invoke `LanguageDetector` and update conversation `language_detected` and `language_confidence` [Source: docs/architecture/components.md#SmsService; docs/architecture/data-models.md#sms_conversations]
  - [x] Conflict handling: If prior language exists, prefer most recent with higher confidence; otherwise keep previous; log decision with structlog [Source: docs/architecture/error-handling-strategy.md#Logging-Standards]
- [x] Persist across conversations (AC: 4)
  - [x] Add `ConversationRepository.find_last_known_language(tenant_id) -> tuple[lang, confidence] | None` to reuse previous tenant language [Source: docs/architecture/components.md#ConversationService]
  - [x] On inbound when conversation has tenant, initialize language from last known tenant value if current detection is `unknown` or lower confidence [Source: docs/architecture/data-models.md#sms_conversations]
- [x] Tenant profile update (AC: 2,5)
  - [x] Create `TenantProfileClient.update_language(tenant_id, lang_code)` using `httpx` with timeouts and retry/backoff for transient errors; noop on `unknown` [Source: docs/architecture/error-handling-strategy.md#External-API-Errors; docs/architecture/tech-stack.md#Technology-Stack-Table]
  - [x] Invoke update when tenant is present and detected language confidence is above threshold (e.g., >=0.7); log audit trail [Source: docs/architecture/error-handling-strategy.md#Logging-Standards]
- [x] Schemas and config (supporting)
  - [x] Add config for `TENANT_PROFILE_API_URL` (and auth if needed later); default safe for local [Source: docs/architecture/coding-standards.md#Config]
- [x] Tests (AC: 1–5)
  - [x] Service tests: EN→ES transitions honoring higher confidence and recency; logs include decision fields (previous, new, chosen, confidence) [Source: docs/architecture/coding-standards.md#Test-Organization]
  - [x] Adapter tests: `TenantProfileClient` success, 404/204 noop, transient 5xx with retry/backoff [Source: docs/architecture/error-handling-strategy.md#External-API-Errors]
  - [x] Persist-across-conversations test: second conversation for same tenant reuses last known language when new signal is weaker/unknown

**Dev Notes**
- Components & Responsibilities:
  - `LanguageDetector`: lightweight heuristic detector for EN/ES/PT that returns `(code, confidence)` used by services. [Source: docs/architecture/components.md#LanguageDetector]
  - `SmsService`: after persisting inbound message, detect language and update conversation fields; decide on conflicts by recency and confidence; trigger tenant profile update if tenant present. [Source: docs/architecture/components.md#SmsService]
  - `ConversationService/Repository`: provide lookup of last-known language by tenant to seed or compare; persist `language_detected` and `language_confidence`. [Source: docs/architecture/components.md#ConversationService; docs/architecture/data-models.md#sms_conversations]

- Data Models:
  - `sms_conversations.language_detected (en|es|pt|unknown)` and `language_confidence (0..1)` must be updated on inbound. [Source: docs/architecture/data-models.md#sms_conversations]

- Error Handling & Retries:
  - External tenant profile update uses httpx timeouts (~3s) and exponential backoff with jitter for 5xx/timeouts; does not block webhook; failures are logged and can be retried later. [Source: docs/architecture/error-handling-strategy.md#External-API-Errors]

- Logging:
  - structlog JSON with `request_id`, `twilio_sid`, `tenant_id`, `language_prev`, `language_new`, `confidence_prev`, `confidence_new`, `chosen`, and whether a profile update was attempted/succeeded. [Source: docs/architecture/error-handling-strategy.md#Logging-Standards]

- File Locations (align with structure):
  - `src/services/sms.py` — extend inbound to update language and invoke tenant profile update
  - `src/services/language.py` — `LanguageDetector` implementation
  - `src/repositories/conversations.py` — add `find_last_known_language(tenant_id)` and setters
  - `src/adapters/tenant_profile_client.py` — external client for language preference update
  - `src/utils/config.py` — settings for `TENANT_PROFILE_API_URL`
  - `tests/unit/services/test_language_persistence.py`
  - `tests/unit/adapters/test_tenant_profile_client.py`
  [Source: docs/architecture/project-structure.md#Source-Directories]

- Technical Constraints:
  - Python 3.11; FastAPI; httpx; structlog; Pydantic; SQLAlchemy async. No network calls in unit tests; mock with `respx`. [Source: docs/architecture/tech-stack.md#Technology-Stack-Table]

### Testing
- Approach: Unit tests for detector heuristics, service conflict-resolution and persistence across conversations, and adapter behavior with retries. [Source: docs/architecture/coding-standards.md#Test-Organization]
- Key Scenarios:
  - Inbound EN text sets language to `en` with confidence and logs decision.
  - Subsequent ES text with higher confidence overrides to `es`; tenant profile update invoked once per change.
  - Low-confidence/unknown does not override higher-confidence prior value; logs audit.
  - Second conversation for same tenant reuses last known language unless new evidence has higher confidence.
  - Tenant profile client retries on 5xx/timeouts; 404/204 treated as noop without raising.
- Success Criteria: AC 1–5 satisfied; logs include audit details; webhook path remains resilient.

**Change Log**
| Date       | Version | Description           | Author |
|------------|---------|-----------------------|--------|
| 2025-09-26 | 0.1     | Initial draft created | SM     |
| 2025-09-26 | 1.0     | Implemented language persistence, profile updates, tests | Dev |

**Dev Agent Record**
- Agent Model Used:
  - OpenAI GPT-4 class
- Debug Log References:
  - tests/unit/services/test_language_persistence.py::test_language_updates_and_profile_calls
  - tests/unit/services/test_persist_across_conversations_reuse_last_known
  - tests/unit/adapters/test_tenant_profile_client.py
- Completion Notes List:
  - Implemented conflict resolution with tenant-level last-known reuse
  - Added TenantProfileClient with retries/backoff; wired into inbound flow
  - Added TENANT_PROFILE_API_URL config; safe default retained
  - Unit tests cover transitions, persistence across conversations, and adapter retries
- File List:
  - src/services/sms_inbound.py
  - src/repositories/conversations.py
  - src/adapters/tenant_profile_client.py
  - src/utils/config.py
  - tests/unit/services/test_language_persistence.py
  - tests/unit/adapters/test_tenant_profile_client.py

**QA Results**

- Gate Decision: PASS
- Summary: Implementation satisfies AC 1–5. Inbound flow updates conversation language with confidence, resolves conflicts favoring most recent higher-confidence signal, and reuses tenant-level last-known language when evidence is weak/unknown. Tenant profile updates are invoked when language changes with sufficient confidence and include retries/backoff; webhook path remains resilient on failures. Unit tests cover EN→ES transitions, reuse across conversations for the same tenant, detector heuristics for EN/ES/PT, and adapter retries/404 handling.
- Acceptance Criteria Traceability:
  - AC1: PASS — `SmsInboundService` detects and persists `language_detected` and `language_confidence` via `ConversationRepository.update_language`.
  - AC2: PASS — When tenant present and confidence ≥ 0.7, `TenantProfileClient.update_language` called; failures do not block webhook.
  - AC3: PASS — Chooses most recent evidence when confidence ≥ previous (ties override) and logs decision audit with prev/new/chosen.
  - AC4: PASS — `find_last_known_language(tenant_id)` seeds/retains tenant language across conversations when new evidence is weaker/unknown.
  - AC5: PASS — Tests simulate EN→ES transitions and verify profile updates; detector tests include PT; adapter tests cover success, 404 noop, and retry.
- Risks:
  - Observability: Success/attempt outcome of tenant profile update is not explicitly logged; add an info log on success and include `chosen_confidence` for completeness.
  - Tie-handling: Equal-confidence signals override to the most recent by design; confirm this matches stakeholder expectations.
- Nice-to-Have:
  - Add a service-level PT transition scenario (e.g., ES→PT) alongside existing EN/ES to mirror AC wording.
  - Consider emitting a structured field indicating whether a profile update was attempted and the result.
- Evidence:
  - Code: `src/services/sms_inbound.py`, `src/services/language_detector.py`, `src/repositories/conversations.py`, `src/adapters/tenant_profile_client.py`, `src/utils/config.py`
  - Tests: `tests/unit/services/test_language_persistence.py`, `tests/unit/services/test_language_detector.py`, `tests/unit/adapters/test_tenant_profile_client.py`
