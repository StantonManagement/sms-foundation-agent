# Story 2.3: Language Preference Persistence

**Status:** Approved

**Story**
**As a** tenant experience steward,
**I want** detected language to persist and update tenant preferences,
**so that** downstream workflows can communicate in the tenant’s preferred language.

**Acceptance Criteria**
1. On inbound message, update `conversation.language_detected` and `language_confidence`
2. If a tenant is associated, update tenant profile language preference via existing mechanism/API
3. If multiple messages provide conflicting signals, prefer most recent with higher confidence; record audit trail in logs
4. Language value persists across conversations for the same tenant (reuse last known unless stronger evidence arrives)
5. Tests simulate EN/ES/PT transitions and verify tenant profile updates are invoked appropriately

**Tasks / Subtasks**
- [ ] Language detection component (AC: 1,3)
  - [ ] Implement `LanguageDetector.detect(text) -> tuple[lang_code, confidence]` with simple EN/ES/PT heuristics; return `("unknown", 0.0)` when inconclusive [Source: docs/architecture/components.md#LanguageDetector]
  - [ ] Unit tests for detection across EN/ES/PT phrases; include low-confidence scenarios [Source: docs/architecture/coding-standards.md#Test-Organization]
- [ ] Inbound flow updates (AC: 1,3)
  - [ ] Extend `SmsService.handle_inbound(...)` to invoke `LanguageDetector` and update conversation `language_detected` and `language_confidence` [Source: docs/architecture/components.md#SmsService; docs/architecture/data-models.md#sms_conversations]
  - [ ] Conflict handling: If prior language exists, prefer most recent with higher confidence; otherwise keep previous; log decision with structlog [Source: docs/architecture/error-handling-strategy.md#Logging-Standards]
- [ ] Persist across conversations (AC: 4)
  - [ ] Add `ConversationRepository.find_last_known_language(tenant_id) -> tuple[lang, confidence] | None` to reuse previous tenant language [Source: docs/architecture/components.md#ConversationService]
  - [ ] On inbound when conversation has tenant, initialize language from last known tenant value if current detection is `unknown` or lower confidence [Source: docs/architecture/data-models.md#sms_conversations]
- [ ] Tenant profile update (AC: 2,5)
  - [ ] Create `TenantProfileClient.update_language(tenant_id, lang_code)` using `httpx` with timeouts and retry/backoff for transient errors; noop on `unknown` [Source: docs/architecture/error-handling-strategy.md#External-API-Errors; docs/architecture/tech-stack.md#Technology-Stack-Table]
  - [ ] Invoke update when tenant is present and detected language confidence is above threshold (e.g., >=0.7); log audit trail [Source: docs/architecture/error-handling-strategy.md#Logging-Standards]
- [ ] Schemas and config (supporting)
  - [ ] Add config for `TENANT_PROFILE_API_URL` (and auth if needed later); default safe for local [Source: docs/architecture/coding-standards.md#Config]
- [ ] Tests (AC: 1–5)
  - [ ] Service tests: EN→ES transitions honoring higher confidence and recency; logs include decision fields (previous, new, chosen, confidence) [Source: docs/architecture/coding-standards.md#Test-Organization]
  - [ ] Adapter tests: `TenantProfileClient` success, 404/204 noop, transient 5xx with retry/backoff [Source: docs/architecture/error-handling-strategy.md#External-API-Errors]
  - [ ] Persist-across-conversations test: second conversation for same tenant reuses last known language when new signal is weaker/unknown

**Dev Notes**
- Components & Responsibilities:
  - `LanguageDetector`: lightweight heuristic detector for EN/ES/PT that returns `(code, confidence)` used by services. [Source: docs/architecture/components.md#LanguageDetector]
  - `SmsService`: after persisting inbound message, detect language and update conversation fields; decide on conflicts by recency and confidence; trigger tenant profile update if tenant present. [Source: docs/architecture/components.md#SmsService]
  - `ConversationService/Repository`: provide lookup of last-known language by tenant to seed or compare; persist `language_detected` and `language_confidence`. [Source: docs/architecture/components.md#ConversationService; docs/architecture/data-models.md#sms_conversations]

- Data Models:
  - `sms_conversations.language_detected (en|es|pt|unknown)` and `language_confidence (0..1)` must be updated on inbound. [Source: docs/architecture/data-models.md#sms_conversations]

- Error Handling & Retries:
  - External tenant profile update uses httpx timeouts (~3s) and exponential backoff with jitter for 5xx/timeouts; does not block webhook; failures are logged and can be retried later. [Source: docs/architecture/error-handling-strategy.md#External-API-Errors]

- Logging:
  - structlog JSON with `request_id`, `twilio_sid`, `tenant_id`, `language_prev`, `language_new`, `confidence_prev`, `confidence_new`, `chosen`, and whether a profile update was attempted/succeeded. [Source: docs/architecture/error-handling-strategy.md#Logging-Standards]

- File Locations (align with structure):
  - `src/services/sms.py` — extend inbound to update language and invoke tenant profile update
  - `src/services/language.py` — `LanguageDetector` implementation
  - `src/repositories/conversations.py` — add `find_last_known_language(tenant_id)` and setters
  - `src/adapters/tenant_profile_client.py` — external client for language preference update
  - `src/utils/config.py` — settings for `TENANT_PROFILE_API_URL`
  - `tests/unit/services/test_language_persistence.py`
  - `tests/unit/adapters/test_tenant_profile_client.py`
  [Source: docs/architecture/project-structure.md#Source-Directories]

- Technical Constraints:
  - Python 3.11; FastAPI; httpx; structlog; Pydantic; SQLAlchemy async. No network calls in unit tests; mock with `respx`. [Source: docs/architecture/tech-stack.md#Technology-Stack-Table]

### Testing
- Approach: Unit tests for detector heuristics, service conflict-resolution and persistence across conversations, and adapter behavior with retries. [Source: docs/architecture/coding-standards.md#Test-Organization]
- Key Scenarios:
  - Inbound EN text sets language to `en` with confidence and logs decision.
  - Subsequent ES text with higher confidence overrides to `es`; tenant profile update invoked once per change.
  - Low-confidence/unknown does not override higher-confidence prior value; logs audit.
  - Second conversation for same tenant reuses last known language unless new evidence has higher confidence.
  - Tenant profile client retries on 5xx/timeouts; 404/204 treated as noop without raising.
- Success Criteria: AC 1–5 satisfied; logs include audit details; webhook path remains resilient.

**Change Log**
| Date       | Version | Description           | Author |
|------------|---------|-----------------------|--------|
| 2025-09-26 | 0.1     | Initial draft created | SM     |

**Dev Agent Record**
- Agent Model Used:
  - 
- Debug Log References:
  - 
- Completion Notes List:
  - 
- File List:
  - 

**QA Results**

