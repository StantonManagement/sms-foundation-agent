# Story 3.3: Retry for Sends

**Status:** Done

**Story**
**As a** resilient service,
**I want** retry logic for transient provider errors,
**so that** temporary failures don’t drop messages.

**Acceptance Criteria**
1: Retries transient Twilio failures with exponential backoff (bounded attempts)
2: Clear error responses for non-retryable failures; logs include error category and correlation IDs
3: Tests cover transient retry and permanent failure paths

**Tasks / Subtasks**
- [x] Define error classification and envelope (AC: 2)
  - [x] In `src/adapters/twilio_client.py`, map Twilio/HTTP errors to domain exceptions with categories: `transient` (timeouts, 5xx, 429) vs `permanent` (4xx like 400/401/403/404/422). Include provider status code, message, and a `correlation_id` if available. [Source: docs/architecture/error-handling-strategy.md#Error-Handling-Patterns; docs/architecture/components.md#TwilioClient]
  - [x] Use ApiError envelope at API boundary for permanent failures with code `sms.external_failed` and include `request_id`. [Source: docs/architecture/error-handling-strategy.md#Business-Logic-Errors]
- [x] Implement retry policy with jitter (AC: 1)
  - [x] Add helper `src/utils/retry.py` implementing async exponential backoff with full jitter (base=100ms, cap=2000ms, attempts=3–5), respecting `Retry-After` if present for 429. [Source: docs/architecture/error-handling-strategy.md#External-API-Errors]
  - [x] Extend `SmsOutboundService.send(...)` to retry on `transient` errors from `TwilioClient.send_sms`, up to `settings.twilio_send_max_retries` with bounded backoff; on success update message status accordingly, on exhaustion raise ExternalServiceError surfaced as ApiError. [Source: docs/architecture/components.md#SmsService]
- [x] Settings (AC: 1)
  - [x] Add to `src/utils/config.py`: `TWILIO_SEND_MAX_RETRIES` (default 3), `TWILIO_SEND_BASE_BACKOFF_MS` (100), `TWILIO_SEND_BACKOFF_CAP_MS` (2000). [Source: docs/architecture/error-handling-strategy.md#External-API-Errors]
- [x] Logging & Metrics (AC: 2)
  - [x] Log `outbound_sms_retry` with fields: `request_id`, `attempt`, `backoff_ms`, `error_category`, `status_code`, `twilio_sid?`, `to`. [Source: docs/architecture/error-handling-strategy.md#Logging-Standards]
  - [x] On final failure, log `outbound_sms_failed` with `error_category=permanent|exhausted` and emit counter metrics for `outbound_sms_failed` with labels. [Source: docs/architecture/components.md#Observability-Health]
- [x] Tests (AC: 3)
  - [x] `tests/unit/services/test_sms_outbound_retry.py`: transient error then success → retries performed, sleeps invoked per policy, returns 202 with sid.
  - [x] `tests/unit/services/test_sms_outbound_retry.py`: permanent error (e.g., 400) → no retries, returns ApiError 4xx with code `sms.external_failed`.
  - [x] `tests/unit/services/test_sms_outbound_retry.py`: 429 with Retry-After respected once; capped by settings; logs emitted.

**Dev Notes**
- Previous Story Insights: 3.1 added outbound send endpoint and service with Twilio adapter; 3.2 handles status callbacks. 3.3 strengthens resilience for transient send errors per architecture’s external API error policy. [Source: docs/prd/epic-3-details-outbound-send-delivery-tracking.md]

- Data Models:
  - No schema changes required. Outbound message `delivery_status` should remain `pending` on transient failures and may be set to `failed` on permanent failures; event history is captured by 3.2 callbacks (send errors are logged locally). [Source: docs/architecture/data-models.md#sms_messages]

- API Specifications:
  - Endpoint: `POST /sms/send` continues to return 202 on success. On permanent errors, return `ApiError` with 4xx or 5xx depending on classification; include `request_id` and error code `sms.external_failed`. [Source: docs/architecture/error-handling-strategy.md#Business-Logic-Errors]

- Component Specifications:
  - `TwilioClient`: expose rich exception types or error result with `category` and `status_code`; timeouts configured via httpx (connect/read ~3s). [Source: docs/architecture/tech-stack.md#Technology-Stack-Table]
  - `SmsOutboundService`: wraps client call in retry policy; updates message status only when send accepted; logs each attempt and the final outcome. [Source: docs/architecture/components.md#SmsService]

- File Locations:
  - `src/utils/retry.py` — backoff helper (async)
  - `src/services/sms_outbound.py` — integrate retry loop
  - `src/adapters/twilio_client.py` — classify errors and expose details
  - `src/utils/config.py` — retry/backoff settings
  - Tests: `tests/unit/services/test_sms_outbound_retry.py`
  [Source: docs/architecture/project-structure.md#Source-Directories]

- Testing Requirements:
  - Use `pytest-asyncio`; monkeypatch Twilio client to raise transient/permanent exceptions; monkeypatch `asyncio.sleep`/retry helper to validate backoff without delay; assert logs via structlog capturing. [Source: docs/architecture/coding-standards.md#Core-Standards]

- Technical Constraints:
  - Keep total retry duration bounded (<= ~3–4s by default). Respect 429 Retry-After when reasonable but cap at configured maximum to maintain API responsiveness. [Source: docs/architecture/error-handling-strategy.md#External-API-Errors]

### Testing
- Approach: Service-focused tests with mocked client and sleep; API-level test for permanent failure mapping.
- Key Scenarios:
  - Transient 5xx then success → attempts=2, 202 OK, logs include attempt/backoff.
  - Permanent 400 → 4xx ApiError, no retries, message not marked sent; logs include category.
  - 429 with Retry-After → single wait respected (capped), then success/failure handled accordingly.
- Success Criteria: AC 1–3 met; logs and metrics confirm behavior; retry bounded by settings.

**Change Log**
| Date       | Version | Description           | Author |
|------------|---------|-----------------------|--------|
| 2025-09-27 | 0.1     | Initial draft created | SM     |
| 2025-09-27 | 0.2     | Apply QA fixes: Retry-After precedence, labeled metrics, tests added | Dev |

**Dev Agent Record**
- Agent Model Used:
  - James (dev) via Codex CLI
- Debug Log References:
  - outbound_sms_retry, outbound_sms_failed, outbound_sms_sent events observed in tests
- Completion Notes List:
  - Implemented Twilio error classification and Retry-After handling
  - Added async retry helper with full jitter and integrated into service
  - Introduced ApiError envelope mapping in /sms/send for permanent/exhausted failures
  - Added unit tests for transient retry, permanent failure mapping, and 429 backoff
- File List:
  - src/adapters/twilio_client.py (updated)
  - src/services/sms_outbound.py (updated)
  - src/utils/retry.py (added)
  - src/utils/config.py (updated)
  - src/api/sms.py (updated)
  - tests/unit/services/test_sms_outbound_retry.py (added)

**QA Results**
- Gate: PASS
- Status Reason: Verified in code and tests. `src/utils/retry.py` prefers provider `retry_after_ms` over computed backoff (bounded by cap). `src/services/sms_outbound.py` emits labeled `outbound_sms_failed` metrics. Unit tests assert both behaviors and pass.
- Findings (resolved):
  - RET-002 (medium): Fixed by honoring provider Retry-After when present, capped by `twilio_send_backoff_cap_ms`.
  - OBS-003 (low): Fixed by adding labels to failure metric (`category`, `route`, `status_code`, `correlation_id`).
- Evidence:
  - Code: `src/utils/retry.py`, `src/services/sms_outbound.py`, `src/adapters/twilio_client.py`
  - Tests: `tests/unit/services/test_sms_outbound_retry.py::test_429_retry_after_respected`, `::test_429_retry_after_larger_than_backoff_uses_provider_hint`, `::test_permanent_failure_emits_labeled_metric`, `::test_transient_exhaustion_emits_labeled_metric` (all green)
- Decision: Gate = PASS
