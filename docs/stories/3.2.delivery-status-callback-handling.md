# Story 3.2: Delivery Status Callback Handling

**Status:** Done

**Story**
**As the** SMS foundation service,
**I want** to receive and record Twilio delivery status callbacks,
**so that** I can track message lifecycle and surface accurate state.

**Acceptance Criteria**
1: POST /webhook/twilio/status verifies signature; accepts form payloads
2: Maps callback to sms_messages by Twilio MessageSid; updates delivery_status (queued, sent, delivered, failed)
3: Updates sms_conversations.last_message_at on relevant updates
4: Logs include previous->new status transition; ignores duplicates idempotently
5: Tests simulate each status and duplicate callbacks

**Tasks / Subtasks**
- [x] Add API route for status callbacks (AC: 1,4)
  - [x] Implement `POST /webhook/twilio/status` in `src/api/webhooks/twilio.py` reusing the existing signature compute/verify helper used for `/sms` [Source: docs/architecture/components.md#WebhookRouter; docs/architecture/error-handling-strategy.md#Logging-Standards]
  - [x] Accept `application/x-www-form-urlencoded` payload; extract `MessageSid` and `MessageStatus` [Source: docs/prd/epic-3-details-outbound-send-delivery-tracking.md]
  - [x] Emit structured logs with request_id, twilio_sid, previous_status, new_status, duplicate flag
- [x] Introduce StatusService (AC: 2–4)
  - [x] Create `src/services/status_service.py` with `process_status(payload, session, *, request_id)` [Source: docs/architecture/components.md#StatusService]
  - [x] Map Twilio statuses (`queued`, `sending`, `sent`, `delivered`, `undelivered`, `failed`, etc.) to internal states and update `sms_messages.delivery_status` idempotently [Source: docs/architecture/data-models.md#sms_messages]
  - [x] Touch `sms_conversations.last_message_at` for statuses representing delivery/receipt events [Source: docs/architecture/components.md#ConversationService]
- [x] Data model and repositories (AC: 2–4)
  - [x] Add new model/table `sms_message_status_events` to record history with `message_id`, `event_status`, `error_code?`, `raw_webhook_data`, `created_at` [Source: docs/architecture/data-models.md#sms_message_status_events]
  - [x] Create `StatusEventRepository` with idempotent append (ignore duplicates by `(message_id, event_status, created_at?)` policy or content hash) [Source: docs/architecture/components.md#Repository-Layer]
  - [x] Extend `MessageRepository` with `get_by_sid(sid)`, `update_status(message_id, status)` if not already sufficient [Source: docs/architecture/components.md#Repository-Layer]
- [x] Idempotency handling (AC: 4)
  - [x] If the incoming status equals the stored `delivery_status`, treat as duplicate and no-op while still recording a status event if not yet recorded (or skip per policy) [Source: docs/architecture/coding-standards.md#Critical-Rules]
- [x] Error handling and responses (AC: 1)
  - [x] On missing `MessageSid` or signature failure: 403/200 no-op per webhook best practices; prefer 200 with logged warning except for auth failure which returns 403 [Source: docs/architecture/error-handling-strategy.md#Error-Handling-Patterns]
- [x] Tests (AC: 5)
  - [x] API tests: signature invalid returns 403; valid callback updates status and 200 OK; duplicate callback is idempotent [Source: docs/architecture/coding-standards.md#Test-Organization]
  - [x] Service tests: status progression queued→sent→delivered; undelivered/failed path updates; last_message_at touch on delivered [Source: docs/architecture/components.md#StatusService]
  - [x] Event history tests: events appended for each callback; duplicates not duplicated

**Dev Notes**
- Previous Story Insights: 3.1 creates outbound messages with `delivery_status=pending` and updates to `queued/sent` when Twilio returns a SID. 3.2 consumes subsequent Twilio callbacks to finalize lifecycle and maintain event history. [Source: docs/prd/epic-3-details-outbound-send-delivery-tracking.md]

- Data Models:
  - `sms_messages`: ensure `delivery_status` supports values: `queued|sending|sent|delivered|undelivered|failed|receiving|received|unknown`. Status transitions are monotonic and idempotent. [Source: docs/architecture/data-models.md#sms_messages]
  - `sms_message_status_events`: add with fields `(id, message_id fk, event_status, error_code?, raw_webhook_data, created_at)` to persist callback snapshots. [Source: docs/architecture/data-models.md#sms_message_status_events]

- API Specifications:
  - Endpoint: `POST /webhook/twilio/status` form-encoded; verify Twilio signature using existing helper; return 200 OK for processed or duplicate; 403 on auth failure. [Source: docs/architecture/components.md#WebhookRouter]

- Component Specifications:
  - `StatusService`: Given `MessageSid` and `MessageStatus`, load message by SID, update `delivery_status` if progressed, record status event row with raw payload, and touch conversation timestamps when applicable. [Source: docs/architecture/components.md#StatusService]

- File Locations:
  - `src/api/webhooks/twilio.py` — add `/status` route alongside `/sms`
  - `src/services/status_service.py` — new service for processing callbacks
  - `src/repositories/status_events.py` — repository for status event history
  - `src/db/models.py` — add `SmsMessageStatusEvent` model
  - Tests: `tests/unit/api/test_twilio_status_webhook.py`, `tests/unit/services/test_status_service.py`
  [Source: docs/architecture/project-structure.md#Source-Directories]

- Testing Requirements:
  - Simulate callbacks for `queued`, `sent`, `delivered`, and `failed/undelivered`; verify idempotency on duplicates; ensure event history rows are recorded without duplication; verify `last_message_at` touched on delivered. [Source: docs/architecture/coding-standards.md#Core-Standards]

- Technical Constraints:
  - Reuse structlog with `request_id`, `twilio_sid`, and transition fields; keep webhook handler quick and resilient. [Source: docs/architecture/error-handling-strategy.md#Logging-Standards]

### Testing
- Approach: API tests for signature verification, success, and idempotency; service tests for status progression and event history.
- Key Scenarios:
  - Valid callback updates message status and appends an event; 200 OK
  - Duplicate callback with same status is idempotent; no second update
  - Failure statuses update appropriately and are logged with status transition fields
  - `last_message_at` updated on delivery events
- Success Criteria: AC 1–5 satisfied with passing tests, structured logs include transitions, and duplicates are safely ignored.

**Change Log**
| Date       | Version | Description           | Author |
|------------|---------|-----------------------|--------|
| 2025-09-27 | 0.1     | Initial draft created | SM     |
| 2025-09-27 | 1.0     | Implemented endpoints, service, model, tests; all AC passing | dev |

**Dev Agent Record**
- Agent Model Used:
  - dev (James)
- Debug Log References:
  - status_processed, twilio_status_webhook_received
- Completion Notes List:
  - Implemented delivery status callbacks end-to-end with idempotent event history and tests.
- File List:
  - src/db/models.py
  - src/repositories/status_events.py
  - src/services/status_service.py
  - src/api/webhooks/twilio.py
  - tests/unit/api/test_twilio_status_webhook.py
  - tests/unit/services/test_status_service.py

**QA Results**
Gate: PASS

Summary:
- All ACs (1–5) are implemented and covered by tests. Signature verification returns 403 on auth failure; valid form-encoded callbacks are accepted (AC1).
- Status mapping by `MessageSid` updates `sms_messages.delivery_status` with normalized states and respects terminal transitions (AC2).
- `sms_conversations.last_message_at` is touched on delivered events; behavior validated in tests (AC3).
- Structured logs include `previous_status`, `new_status`, `request_id`, `twilio_sid`, and `duplicate` flag; duplicates are idempotently ignored and not re-recorded due to event-hash uniqueness (AC4).
- Tests simulate status progression and duplicates, plus invalid signature path (AC5).

NFR Snapshot:
- Security: PASS — HMAC signature verification implemented; 403 on failure. Note: in production behind a proxy, ensure the URL used for signature computation matches Twilio’s external URL (consider documenting proxy/header handling).
- Reliability: PASS — Idempotent updates and event history with unique hash prevent duplication; DB errors are handled with warnings to keep webhook resilient.
- Observability: PASS — Structured logs include key identifiers and transitions.
- Maintainability: PASS — Clear separation via `StatusService` and repository layer; tests provide good regression coverage.

Risks/Notes:
- Low: Only delivered updates touch `last_message_at`; if future requirements treat other statuses as activity, extend accordingly.
- Low: Ensure migration for `sms_message_status_events` is applied in all environments.

Recommendations:
- Add a short ops note on expected external URL vs. `request.url` for Twilio signature verification when running behind load balancers/reverse proxies.

Gate File: docs/qa/gates/3.2-delivery-status-callback-handling.yml
