# Story 1.4: Persist Inbound Messages and Conversations + Baseline Language Detection

**Status:** Fixed

**Story**
**As a** data platform consumer,
**I want** inbound SMS persisted with full raw payload and conversation linkage,
**so that** downstream services can rely on durable, queryable records.

**Acceptance Criteria**
1. Inserts into `sms_messages` with `direction=inbound`, `message_content`, `twilio_sid`, `raw_webhook_data` (JSONB), `created_at`
2. Creates/updates `sms_conversations` for the phone number (unknown tenant allowed) and updates `last_message_at`
3. Stores `language_detected` and `language_confidence` on conversation using EN/ES/PT heuristics (e.g., "Sí/Si" → Spanish; "Sim" → Portuguese; "Yes" → English)
4. `GET /conversations/{phone_number}` returns conversation with latest messages (basic pagination ok or deferred to Epic 2)
5. Tests cover persistence and language heuristic paths (English/Spanish/Portuguese/unknown)

**Tasks / Subtasks**
- [ ] Dependencies & setup (AC: 1–5)
  - [x] Add missing libs per Tech Stack: `SQLAlchemy[asyncio]`, `alembic`, `asyncpg` (prod), `aiosqlite` (tests), `phonenumbers` [Source: architecture/tech-stack.md#Technology Stack Table]
  - [x] Ensure `DATABASE_URL` supports async drivers (e.g., `sqlite+aiosqlite:///./app.db` locally; `postgresql+asyncpg://...` prod) [Source: architecture/tech-stack.md#Technology Stack Table]
- [ ] Database models & migrations (AC: 1–3)
  - [x] Add `SmsConversation` model with fields: `id`, `phone_number_canonical` (E.164, UNIQUE), `phone_number_original`, `tenant_id` (nullable), `language_detected` (`en|es|pt|unknown`), `language_confidence` (numeric), `last_message_at`, `created_at`, `updated_at` [Source: architecture/data-models.md#sms_conversations]
  - [x] Extend `SmsMessage` model with: `conversation_id` (FK→`sms_conversations`), `from_number`, `to_number`, `message_content`, `raw_webhook_data` (JSON/JSONB), `updated_at` [Source: architecture/data-models.md#sms_messages]
  - [x] Create Alembic migration: create `sms_conversations` (UNIQUE `phone_number_canonical`) and alter/create `sms_messages` with UNIQUE `twilio_sid`, FK to conversation, and indexes on `(conversation_id, created_at)` [Source: architecture/error-handling-strategy.md#Data Consistency]
- [ ] Repository layer (AC: 1–4)
  - [x] `ConversationRepository`: `get_by_phone(phone_canon)`, `upsert_by_phone(original, canon)`, `update_language(id, lang, conf)`, `touch_last_message_at(id, ts)` [Source: architecture/coding-standards.md#Repository Pattern; architecture/components.md#ConversationService]
  - [x] `MessageRepository`: `get_by_sid(sid)`, `insert_inbound_full(conversation_id, sid, from_number, to_number, content, raw_json)` (atomic), `list_by_conversation(conversation_id, limit, offset)` [Source: architecture/coding-standards.md#Repository Pattern]
- [ ] Services (AC: 1–3)
  - [x] Implement `LanguageDetector` with simple EN/ES/PT heuristics and confidence scores (e.g., contains "sí"/"si"→es, "sim"→pt, "yes"→en; else unknown). Return `(lang, confidence)` [Source: architecture/components.md#LanguageDetector]
  - [x] Implement `SmsService.handle_inbound(payload)` flow: extract `MessageSid`, `From`, `To`, `Body`; normalize phone → `phone_number_canonical`; `upsert` conversation; perform idempotent insert of message (unique `twilio_sid` guard); update conversation `last_message_at`; compute and set language fields [Source: architecture/components.md#SmsService; architecture/coding-standards.md#Idempotency]
  - [x] Handle race-safe insert: rely on DB unique constraint on `twilio_sid`; catch unique violation → treat as duplicate no-op; still `200` at webhook [Source: architecture/error-handling-strategy.md#Data Consistency]
- [ ] API integration (AC: 1–4)
  - [x] Update `POST /webhook/twilio/sms` to call `SmsService.handle_inbound(...)` after signature verification and before returning 200 [Source: architecture/components.md#WebhookRouter]
  - [x] Add `GET /conversations/{phone_number}` to return conversation (normalized by E.164) with latest messages; accept `limit` (default 20) and `offset` (default 0) for basic pagination [Source: architecture/components.md#ConversationService]
  - [x] Define Pydantic response models; do not return ORM objects directly [Source: architecture/coding-standards.md#Core Standards]
- [ ] Logging & validation (AC: 1–4)
  - [x] Structured logs for inbound processing with `request_id`, `twilio_sid`, `phone`, `duplicate` flag; never log secrets or full PII payload [Source: architecture/error-handling-strategy.md#Logging Standards]
  - [x] Validate and normalize phone numbers with `phonenumbers`; store both original and canonical E.164 [Source: architecture/coding-standards.md#Validation]
- [ ] Tests (AC: 5)
  - [x] Service tests: initial insert persists message + conversation; second insert with same `MessageSid` does not create another row; language detection returns expected `(lang, confidence)` for EN/ES/PT and unknown [Source: architecture/coding-standards.md#Test Organization]
  - [x] API tests:
    - [x] Webhook flow (with valid signature) persists data and returns 200 quickly
    - [x] `GET /conversations/{phone_number}` returns conversation and messages ordered by `created_at` desc; supports `limit` [Source: architecture/components.md#WebhookRouter]
  - [x] Test DB: use SQLite `sqlite+aiosqlite` and create schema per models for unit scope; avoid network calls [Source: architecture/tech-stack.md#Testing]
- [ ] Project structure alignment & docs
  - [ ] Place files per structure: `src/api/conversations.py`, `src/services/sms.py`, `src/services/language.py`, `src/repositories/conversations.py`, `src/repositories/messages.py`, update `src/db/models.py` [Source: architecture/project-structure.md#Source Directories]
  - [ ] Update README with brief note on new endpoint and local DB setup (optional)

**Dev Notes**
- Previous Story Insights: Story 1.3 added idempotency by `twilio_sid` with a unique constraint and a service path that catches unique violations as duplicates. Extend that flow so the webhook (after signature verification) routes to `SmsService.handle_inbound(...)`, which persists message + conversation and updates language, still returning 200 quickly. [Source: stories/1.3.idempotency-by-messagesid.md]

- Data Models:
  - `sms_conversations`: per spec with unique `phone_number_canonical`, language fields, and `last_message_at`. [Source: architecture/data-models.md#sms_conversations]
  - `sms_messages`: include `conversation_id`, `direction` (inbound), `twilio_sid` (UNIQUE), `from_number`, `to_number`, `message_content`, `raw_webhook_data` JSON, timestamps. [Source: architecture/data-models.md#sms_messages]

- API/Service Design:
  - Webhook Router delegates to `SmsService` for orchestration; service enforces idempotency and persists domain entities. [Source: architecture/components.md#WebhookRouter; architecture/components.md#SmsService]
  - Conversation operations encapsulated in `ConversationService`/repo; listing via `GET /conversations/{phone_number}` with simple pagination. [Source: architecture/components.md#ConversationService]
  - Language detection extracted to `LanguageDetector` utility/service; heuristics are simple, fast, and synchronous. [Source: architecture/components.md#LanguageDetector]

- Validation & Normalization:
  - Normalize phone numbers to E.164 using `phonenumbers` before storage/lookup; store original input as well. [Source: architecture/coding-standards.md#Validation]

- Error Handling & Logging:
  - Use structlog JSON logs; include `request_id`, `twilio_sid`, `phone`, and `duplicate` flag; never log secrets/PII. [Source: architecture/error-handling-strategy.md#Logging Standards]
  - Rely on DB unique constraint for idempotency; catch and translate unique violations to duplicate no-op. [Source: architecture/error-handling-strategy.md#Data Consistency]

- Performance:
  - Keep webhook response fast; do minimal synchronous work (persist and language heuristics). Heavier enrichment (tenant lookup) is deferred to later stories/background tasks. [Source: architecture/coding-standards.md#Background Work]

- File Locations (align with structure):
  - `src/api/webhooks/twilio.py` — call `SmsService.handle_inbound(...)` after signature verification
  - `src/api/conversations.py` — `GET /conversations/{phone_number}`
  - `src/services/sms.py` — orchestration logic
  - `src/services/language.py` — `LanguageDetector`
  - `src/repositories/messages.py`, `src/repositories/conversations.py` — repository layer
  - `src/db/models.py` — models for `SmsConversation`, `SmsMessage`
  - `tests/unit/services/test_inbound_persistence_and_language.py` — service tests
  - `tests/unit/api/test_conversations_get.py` — API tests
  [Source: architecture/project-structure.md#Source Directories]

- Technical Constraints:
  - Python 3.11; FastAPI; SQLAlchemy 2.x async; Alembic; structlog; phonenumbers; Postgres in production, SQLite allowed for unit tests. [Source: architecture/tech-stack.md#Technology Stack Table]

### Testing
- Approach: Unit tests at service level for persistence + language; API tests for webhook flow and `GET /conversations/{phone_number}`. Avoid external network calls. [Source: architecture/coding-standards.md#Test Organization]
- Key Scenarios:
  - First inbound with new `MessageSid` → creates conversation (if absent), inserts message, updates `last_message_at`.
  - Duplicate inbound with same `MessageSid` → no additional message; still 200 at webhook; logs `duplicate=true` (covered by 1.3, ensure no regression).
  - Language detection: "Yes" → `en`; "Sí"/"Si" → `es`; "Sim" → `pt`; unrelated text → `unknown`; confidence reflects heuristic match.
  - `GET /conversations/{phone_number}` returns the conversation and latest messages ordered by `created_at` desc; supports `limit`.
- Success Criteria: AC 1–5 demonstrably satisfied by tests; schema constraints (UNIQUE/FK) validated in unit scope using SQLite.

**Change Log**
| Date       | Version | Description           | Author |
|------------|---------|-----------------------|--------|
| 2025-09-26 | 0.1     | Initial draft created | SM     |

**Dev Agent Record**
- Agent Model Used: James (dev) via Codex CLI
- Debug Log References:
  - Added logs: `twilio_webhook_received`, `inbound_sms_processed`, `inbound_sms_missing_sid`, `inbound_sms_db_unavailable` with fields: `request_id`, `twilio_sid`, `route`, `phone`, `duplicate`.
- Completion Notes List:
  - Implemented conversation and message persistence with idempotency and language detection heuristics.
  - Added GET endpoint to retrieve conversation by phone with latest messages.
  - Fixed Portuguese greeting regex for "olá" detection.
  - Added dependencies: phonenumbers, alembic, asyncpg.
  - Added unit tests for LanguageDetector (EN/ES/PT/unknown) and API tests for conversations (normalization, not-found, ordering, pagination).
  - Ran tests via `venv/pytest`; all passing locally.
- File List:
  - src/db/models.py (modified): Added `SmsConversation`; extended `SmsMessage` with FK, addressing, content, JSON, timestamps
  - src/repositories/conversations.py (added): ConversationRepository
  - src/repositories/messages.py (modified): Full insert and list by conversation
  - src/services/language_detector.py (modified): Heuristic detector for EN/ES/PT
  - src/services/sms_inbound.py (modified): Full inbound flow, idempotent insert, language + last_message_at updates
  - src/api/conversations.py (added): `GET /conversations/{phone_number}` endpoint
  - src/main.py (modified): Registered conversations router
  - requirements.txt (modified): Added phonenumbers, alembic, asyncpg
  - alembic.ini (added): Alembic configuration
  - alembic/env.py (added): Alembic environment using SQLAlchemy metadata
  - alembic/versions/20250926_01_init_conversations_messages.py (added): Create tables, constraints, and indexes
  - tests/unit/services/test_language_detector.py (added): Language heuristics tests
  - tests/unit/api/test_conversations_api.py (added): GET conversations API tests

**QA Results**
Gate Decision: PASS

Summary:
- Core functionality is implemented and verified: inbound messages persist (with raw payload), conversations are upserted and `last_message_at` is updated, baseline language detection (EN/ES/PT/unknown) is applied, and `GET /conversations/{phone_number}` returns the normalized conversation with recent messages and pagination.
- Previously noted gaps have been addressed: tests added for language heuristics and conversations API; Alembic migration added; dependencies updated; Portuguese `olá` regex corrected.

Acceptance Criteria Traceability:
- AC1: Implemented and exercised via service/webhook tests (persistence + required fields).
- AC2: Implemented and exercised (conversation upsert + `last_message_at`).
- AC3: Implemented and tested in `tests/unit/services/test_language_detector.py` (EN/ES/PT/unknown).
- AC4: Implemented and tested in `tests/unit/api/test_conversations_api.py` (normalization, not-found/found, ordering, pagination).
- AC5: Covered by added tests (heuristics validated across EN/ES/PT/unknown).

Evidence Reviewed:
- Code: `src/db/models.py`, `src/repositories/*`, `src/services/language_detector.py`, `src/services/sms_inbound.py`, `src/api/conversations.py`, `src/api/webhooks/twilio.py`.
- Tests: `tests/unit/services/test_language_detector.py`, `tests/unit/api/test_conversations_api.py`, `tests/unit/services/test_inbound_idempotency.py`, `tests/unit/api/test_twilio_webhook_idempotency.py`.
- Migrations/Deps: `alembic/versions/20250926_01_init_conversations_messages.py` present; `requirements.txt` includes `phonenumbers`, `alembic`, `asyncpg`.

Risk Summary:
- Critical: 0, High: 0, Medium: 0, Low: 0

Recommendations:
- Monitor normalization behavior in production and confirm migrations applied in target environments.

Reviewer: Quinn (Test Architect)
Date: 2025-09-26
