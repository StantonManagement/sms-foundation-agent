# Story 2.4: Unknown Number Handling and Later Reconciliation

**Status:** Done

**Story**
**As the** service,
**I want** to handle unknown numbers gracefully and reconcile later when a tenant becomes known,
**so that** data remains durable and relationships can be established post-factum.

**Acceptance Criteria**
1. Messages from unknown numbers create conversations/messages without `tenant_id`
2. When a subsequent message or background reconciliation identifies a tenant, update the existing conversation with `tenant_id`
3. Reconciliation does not duplicate messages or conversations
4. Logs and metrics capture unknown vs known ratio and reconciliation events
5. Tests cover unknown-first then known-later flow

**Tasks / Subtasks**
- [x] Persist unknown conversations (AC: 1)
  - [x] Ensure `SmsService.handle_inbound(...)` upserts conversation and message with `tenant_id = null` when lookup yields no match [Source: docs/architecture/components.md#SmsService; docs/architecture/data-models.md#sms_conversations]
  - [x] Verify idempotency by `twilio_sid` to avoid duplicates [Source: docs/architecture/coding-standards.md#Core-Standards]
- [x] Reconciliation path (AC: 2,3)
  - [x] Add `ConversationService.reconcile_tenant(conversation_id, tenant_id)` that sets `tenant_id` without creating a new conversation; update `last_message_at` as needed [Source: docs/architecture/components.md#ConversationService; docs/architecture/data-models.md#sms_conversations]
  - [x] Create background workflow `workflows/reconciliation.py` to retry `TenantLookupClient` for unknown conversations and apply reconciliation atomically [Source: docs/architecture/components.md#TenantLookupClient]
  - [x] Guard against race conditions with DB uniqueness + transactions; verify no duplicate conversations/messages created [Source: docs/architecture/coding-standards.md#Repository-Pattern]
- [x] Metrics & logging (AC: 4)
  - [x] Emit counters for `unknown_conversation_created`, `reconciliation_succeeded`, `reconciliation_no_match` and structured logs with `phone`, `conversation_id`, previous/new tenant [Source: docs/architecture/components.md#Observability-Health; docs/architecture/error-handling-strategy.md#Logging-Standards]
- [x] Tests (AC: 1–5)
  - [x] Service test: inbound unknown → later known updates same conversation (no duplication) [Source: docs/architecture/coding-standards.md#Test-Organization]
  - [x] Reconciler test: unknown conversation reconciles to tenant via `TenantLookupClient` mock; idempotent on re-run
  - [x] Ensure idempotency by `twilio_sid` prevents duplicates across retries

**Dev Notes**
- Previous Story Insights: 2.1 added phone normalization and tenant lookup; 2.2 introduced retrieval by normalized phone; 2.3 persisted language and tenant preference updates. This story formalizes the unknown→known transition via explicit reconciliation while maintaining idempotency. [Source: docs/prd/epic-2-details-tenant-identification-conversations.md]

- Data Models:
  - `sms_conversations.tenant_id` remains nullable and is set during reconciliation; maintain uniqueness by `phone_number_canonical` to avoid duplicates. [Source: docs/architecture/data-models.md#sms_conversations]

- Components & Responsibilities:
  - `SmsService`: create/update conversations and messages; leave `tenant_id` null when unknown; enqueue background reconciliation. [Source: docs/architecture/components.md#SmsService]
  - `ConversationService`: implement `reconcile_tenant` ensuring atomic update without duplication; update `last_message_at`. [Source: docs/architecture/components.md#ConversationService]
  - `TenantLookupClient`: reused for later lookups using `variants(raw)` from phone utils. [Source: docs/architecture/components.md#TenantLookupClient]

- File Locations (align with structure):
  - `src/services/sms.py` — verify unknown creation logic and enqueue reconciliation
  - `src/services/conversations.py` — add `reconcile_tenant`
  - `src/workflows/reconciliation.py` — background job to attempt tenant resolution
  - `tests/unit/services/test_reconciliation.py`
  - `tests/unit/workflows/test_reconciliation_job.py`
  [Source: docs/architecture/project-structure.md#Source-Directories]

- Technical Constraints:
  - Python 3.11; FastAPI; SQLAlchemy async; structlog; background tasks. Keep webhook fast; reconciliation runs async. [Source: docs/architecture/tech-stack.md]

### Testing
- Approach: Unit tests for unknown→known reconciliation via service and background workflow with mocks; verify no duplication and correct logging/metrics.
- Key Scenarios:
  - Inbound unknown creates conversation with `tenant_id = null`; later inbound from same phone triggers lookup → sets tenant on existing conversation
  - Background reconciler updates tenant for lingering unknown conversations; idempotent on repeat
  - Retrieval by phone returns a single conversation pre/post reconciliation; messages not duplicated
  - Logs include reconciliation event fields; counters increment as expected
- Success Criteria: AC 1–5 satisfied with structured logs and stable idempotency.

**Change Log**
| Date       | Version | Description           | Author |
|------------|---------|-----------------------|--------|
| 2025-09-26 | 0.1     | Initial draft created | SM     |

**Dev Agent Record**
- Agent Model Used:
  - OpenAI GPT-4 class
- Debug Log References:
  - tests/unit/services/test_reconciliation.py::test_unknown_then_known_updates_same_conversation
  - tests/unit/workflows/test_reconciliation_job.py::test_reconciles_unknown_conversations_idempotently
  - tests/unit/services/test_inbound_tenant_lookup.py::test_inbound_no_match_leaves_null
- Completion Notes List:
  - Implemented reconciliation workflow and service method with metrics
  - Added race-safe upsert and unknown listing in repository
  - Instrumented unknown/reconciliation counters and structured logs
  - Added unit tests for unknown→known flow and background job; all tests pass
- File List:
  - src/adapters/metrics.py
  - src/services/sms_inbound.py
  - src/services/conversations.py
  - src/repositories/conversations.py
  - src/workflows/reconciliation.py
  - tests/unit/services/test_reconciliation.py
  - tests/unit/workflows/test_reconciliation_job.py

**QA Results**
\n+- Gate Decision: PASS
- Summary: Implementation satisfies AC 1–5. Inbound processing creates conversations/messages with `tenant_id = null` when no tenant is found; later messages or the background reconciliation job set `tenant_id` on the existing conversation without duplication. Idempotency by `twilio_sid` prevents duplicate messages, and conversation uniqueness by canonical phone prevents duplicate conversations. Observability includes logs for `tenant_lookup_outcome`, `unknown_conversation_created`, and reconciliation events, with metrics for `unknown_conversation_created`, `reconciliation_succeeded`, and `reconciliation_no_match`. Unit tests cover unknown→known via inbound flow, background reconciliation idempotency, and inbound no-match.
- Acceptance Criteria Traceability:
  - AC1: PASS — `SmsInboundService` upserts conversation by canonical phone and persists messages with `tenant_id = null` when no match; see `src/services/sms_inbound.py`, `ConversationRepository.upsert_by_phone_returning_created` and tests in `test_inbound_tenant_lookup.py::test_inbound_no_match_leaves_null`.
  - AC2: PASS — When a tenant is identified (either during inbound or via background job), `tenant_id` is set on the existing conversation; see inbound path `conv_repo.set_tenant(...)` and background `ConversationService.reconcile_tenant(...)`.
  - AC3: PASS — Unique constraints and repository logic prevent duplicates: `twilio_sid` guards message duplicates; conversation uniqueness by `phone_number_canonical` avoids multiple conversations. Verified in tests and by `upsert_by_phone_returning_created`.
  - AC4: PASS — Logs for lookup outcomes and reconciliation; metrics include `unknown_conversation_created`, `reconciliation_succeeded`, `reconciliation_no_match` to support monitoring.
  - AC5: PASS — Tests: `test_unknown_then_known_updates_same_conversation`, `test_reconciles_unknown_conversations_idempotently`, and `test_inbound_no_match_leaves_null` validate the flows.
- Risks / Observability Gaps:
  - Metrics Coverage: No explicit counter for immediate “known during inbound” path. Consider incrementing a metric (e.g., `known_conversation_resolved`) when a tenant match occurs during webhook handling to better measure unknown vs known ratio (today we only increment unknown on conversation creation and background success on reconciliation).
  - Consistency: `reconciliation_succeeded` is incremented via `ConversationService.reconcile_tenant` (background), but not when inbound sets the tenant; consider aligning metric naming/coverage across both paths.
  - Nice-to-have: Emit a per-run summary log for the reconciliation job using the returned summary to improve operational visibility.
- Evidence:
  - Code: `src/services/sms_inbound.py`, `src/services/conversations.py`, `src/repositories/{messages,conversations}.py`, `src/workflows/reconciliation.py`, `src/adapters/metrics.py`
  - Tests: `tests/unit/services/test_reconciliation.py`, `tests/unit/workflows/test_reconciliation_job.py`, `tests/unit/services/test_inbound_tenant_lookup.py`, idempotency tests under `tests/unit/services/test_inbound_idempotency.py` and API duplicate test.
