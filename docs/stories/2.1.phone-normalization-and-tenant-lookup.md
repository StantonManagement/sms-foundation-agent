# Story 2.1: Phone Normalization and Tenant Lookup

**Status:** Approved

**Story**
**As the** SMS foundation service,
**I want** to normalize phone numbers and look up tenants via the Collections Monitor,
**so that** I can reliably associate messages with the correct tenant profile even across number variants.

**Acceptance Criteria**
1. Phone numbers normalized to E.164 using `phonenumbers`; both canonical and original preserved
2. Lookup tries multiple variants (raw, E.164, country-stripped, digits-only) against Collections Monitor API
3. If tenant found, persist `tenant_id` on conversation; if not, conversation remains with null tenant
4. Track most recently used phone number per tenant mapping for future sends
5. Errors from monitor are retried with backoff; definitive 404/empty results do not error the webhook path
6. Tests cover successful match, no match, and transient monitor failure paths

**Tasks / Subtasks**
- [ ] Dependencies & setup (AC: 1,5,6)
  - [ ] Ensure `phonenumbers` and `httpx` are available per tech stack; add retry/backoff helper for external calls (no new deps required) [Source: architecture/tech-stack.md#Technology Stack Table; architecture/error-handling-strategy.md#External API Errors]
  - [ ] Add settings for `MONITOR_API_URL` (and auth if required later); default safe empty for local [Source: architecture/coding-standards.md#Config]
- [ ] Phone normalization utilities (AC: 1–2)
  - [ ] Implement `src/utils/phone.py` with: `to_e164(raw)`, `digits_only(raw)`, `country_stripped(raw)`, and `variants(raw)` producing ordered candidates [Source: architecture/coding-standards.md#Validation]
  - [ ] Use normalization in inbound flow prior to conversation upsert; preserve `phone_number_original` and store `phone_number_canonical` [Source: architecture/data-models.md#sms_conversations]
- [ ] TenantLookupClient (AC: 2,5)
  - [ ] Create `src/adapters/monitor_client.py` with `TenantLookupClient.lookup(variants: list[str]) -> TenantMatch | None` using `httpx` with timeouts and retry/backoff for transient failures [Source: architecture/components.md#TenantLookupClient; architecture/error-handling-strategy.md#External API Errors]
  - [ ] Define `TenantMatch` DTO (Pydantic) as needed; no direct ORM leakage [Source: architecture/coding-standards.md#Core Standards]
- [ ] Conversation updates (AC: 3–4)
  - [ ] Extend `ConversationRepository` with `set_tenant(conversation_id, tenant_id)` and `track_last_used_number(tenant_id, phone_canonical)` [Source: architecture/components.md#ConversationService]
  - [ ] Update `SmsService.handle_inbound(...)` to: compute variants → call `TenantLookupClient` → if found, set `tenant_id` on conversation; always continue the webhook fast path [Source: architecture/components.md#SmsService]
- [ ] Logging & error handling (AC: 5)
  - [ ] Log lookups with `request_id`, `phone`, and outcome: `found|not_found|error` (errors retried and surfaced only to logs/metrics, not API) [Source: architecture/error-handling-strategy.md#Logging Standards]
  - [ ] For definitive no-match (404/empty), do not raise; leave `tenant_id` null [Source: architecture/error-handling-strategy.md#External API Errors]
- [ ] Tests (AC: 1–2,5–6)
  - [ ] Unit tests for `utils/phone.py` normalization/variants generation
  - [ ] `TenantLookupClient` tests with `respx` mocking: success match, no match (404/empty), transient 5xx with retry/backoff, then success/fail
  - [ ] Service-level tests: inbound handling sets tenant when found; preserves null when not found; never errors the webhook path due to monitor failure [Source: architecture/coding-standards.md#Test Organization]

**Dev Notes**
- Previous Story Insights: Story 1.4 persists conversations/messages and applies baseline language detection. This story builds on that: it normalizes phones and associates conversations to tenants when possible via the Collections Monitor. Keep webhook latency low; tenant lookup can be synchronous if fast or moved to background later. [Source: docs/prd/epic-2-details-tenant-identification-conversations.md]

- Components & Responsibilities:
  - `TenantLookupClient`: given phone variants, call Monitor API with timeouts and retries; map to a `tenant_id` if found. [Source: docs/architecture/components.md#TenantLookupClient]
  - `SmsService`: orchestrates normalization → lookup → `ConversationRepository.set_tenant(...)`; do not block webhook excessively. [Source: docs/architecture/components.md#SmsService]
  - `ConversationService/Repo`: maintain `tenant_id` and optionally track last-used number mapping for future sends. [Source: docs/architecture/components.md#ConversationService]

- Data Models:
  - `sms_conversations` already include `tenant_id` (nullable) and phone fields; this story sets `tenant_id` when match found. [Source: docs/architecture/data-models.md#sms_conversations]

- Error Handling & Retries:
  - Use httpx with connect/read timeouts (~3s) and exponential backoff (100ms→2s, 3–5 attempts) for 5xx/timeouts. Do not fail the webhook; log and continue. [Source: docs/architecture/error-handling-strategy.md#External API Errors]

- Logging:
  - structlog JSON with `request_id`, `twilio_sid` (if in context), `phone`, `monitor_outcome`, and retry counts when applicable. [Source: docs/architecture/error-handling-strategy.md#Logging Standards]

- File Locations (align with structure):
  - `src/utils/phone.py` — normalization utilities
  - `src/adapters/monitor_client.py` — `TenantLookupClient`
  - `src/services/sms.py` — extend inbound flow to set tenant
  - `src/repositories/conversations.py` — repo methods to set tenant and track mapping
  - `tests/unit/utils/test_phone.py` — normalization tests
  - `tests/unit/adapters/test_monitor_client.py` — client tests with `respx`
  - `tests/unit/services/test_inbound_tenant_lookup.py` — service flow tests
  [Source: docs/architecture/project-structure.md#Source Directories]

- Technical Constraints:
  - Python 3.11; FastAPI; httpx; structlog; Pydantic. No network calls in unit tests; use `respx` for mocking. [Source: docs/architecture/tech-stack.md#Technology Stack Table]

### Testing
- Approach: Unit tests for utils/client; service tests for end-to-end behavior in process. No live HTTP calls. [Source: docs/architecture/coding-standards.md#Test Organization]
- Key Scenarios:
  - Normalization produces expected E.164 (where possible) and variants list order.
  - Monitor success: returns `tenant_id` → conversation updated.
  - Monitor no match: leaves `tenant_id` null; does not error.
  - Monitor transient error: retries then either succeed or log and continue without failing webhook.
- Success Criteria: AC 1–6 met by tests; logs include clear outcomes; webhook path remains resilient to monitor issues.

**Change Log**
| Date       | Version | Description           | Author |
|------------|---------|-----------------------|--------|
| 2025-09-26 | 0.1     | Initial draft created | SM     |

**Dev Agent Record**
- Agent Model Used:
- Debug Log References:
- Completion Notes List:
  -
- File List:
  -

**QA Results**
(To be completed by QA agent after implementation.)

