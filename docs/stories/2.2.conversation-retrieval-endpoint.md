# Story 2.2: Conversation Retrieval Endpoint

**Status:** Done

**Story**
**As an** integrating service or operator,
**I want** to fetch conversation history by phone number,
**so that** I can display message threads and recent activity.

**Acceptance Criteria**
1. GET `/conversations/{phone_number}` returns conversation metadata (tenant_id if known, workflow_type, last_message_at)
2. Includes paginated messages ordered by created_at desc with fields: direction, content, twilio_sid, delivery_status, created_at
3. Accepts pagination params (page/limit) with sensible defaults
4. Returns 404 if conversation does not exist; 200 with empty messages if exists but no messages
5. Input phone number may be any variant; endpoint normalizes before lookup
6. Tests include pagination, normalization of input, and not-found cases

**Tasks / Subtasks**
- [x] API route for retrieval (AC: 1,2,4,5)
  - [x] Add `GET /conversations/{phone}` to `src/api/conversations.py` using FastAPI `APIRouter`
  - [x] Normalize `phone` input via phone utils before lookup; support raw/E.164/digits-only variants [Source: docs/architecture/coding-standards.md#Validation; docs/architecture/components.md#ConversationService]
  - [x] Return 404 when conversation not found; otherwise 200 with metadata + messages [Source: docs/architecture/error-handling-strategy.md#Business-Logic-Errors]
- [x] Pagination support (AC: 2,3)
  - [x] Implement `page` and `limit` query params with defaults (e.g., page=1, limit=20); validate sane bounds [Source: docs/architecture/coding-standards.md#Core-Standards]
  - [x] Order messages by `created_at` desc; provide `page`, `limit`, `offset`, `total` fields alongside message list [Source: docs/architecture/components.md#ConversationService]
- [x] Service and repositories (AC: 1,2,4)
  - [x] `ConversationRepository.find_by_canonical(phone_canonical) -> Conversation | None` [Source: docs/architecture/components.md#Repository-Layer; docs/architecture/data-models.md#sms_conversations]
  - [x] `MessageRepository.list_for_conversation(conversation_id, page, limit, order="desc") -> tuple[list[Message], int_total]` [Source: docs/architecture/components.md#Repository-Layer; docs/architecture/data-models.md#sms_messages]
  - [x] `ConversationService.get_with_messages_by_phone(phone_raw, page, limit)` to orchestrate normalization, lookup, and listing [Source: docs/architecture/components.md#ConversationService]
- [x] Schemas & DTOs (AC: 1,2)
  - [x] Define Pydantic models for response and message items [Source: docs/architecture/coding-standards.md#Core-Standards]
- [x] Logging & errors (AC: 4)
  - [x] Use structlog with `phone` and outcome; map not found to 404 [Source: docs/architecture/error-handling-strategy.md#Logging-Standards]
- [x] Tests (AC: 2,3,4,5,6)
  - [x] Route tests for: not found (404), normalization; supports limit/offset pagination
  - [x] Service test for normalization and not-found behavior

**Dev Notes**
- Previous Story Insights: Story 2.1 added phone normalization utilities and tenant lookup; normalization should be reused to accept any phone variant for retrieval, and metadata should include `tenant_id` when available. Keep response models consistent and do not leak ORM entities. [Source: docs/prd/epic-2-details-tenant-identification-conversations.md]

- Components & Responsibilities:
  - `ConversationService`: fetch conversation by normalized canonical phone and list messages with pagination. [Source: docs/architecture/components.md#ConversationService]
  - `ConversationRepository` / `MessageRepository`: data access for conversations and messages, ordered by `created_at` desc. [Source: docs/architecture/components.md#Repository-Layer; docs/architecture/data-models.md#sms_messages]
  - `Conversations Router`: expose `GET /conversations/{phone}` for retrieval. [Source: docs/architecture/components.md#WebhookRouter]

- Data Models:
  - `sms_conversations`: `phone_number_canonical`, `phone_number_original`, `tenant_id`, `workflow_type`, `last_message_at`. [Source: docs/architecture/data-models.md#sms_conversations]
  - `sms_messages`: `direction`, `message_content`, `twilio_sid`, `delivery_status`, `created_at`. [Source: docs/architecture/data-models.md#sms_messages]

- Coding Standards & Validation:
  - Use Pydantic models for API responses; repository pattern for DB access; normalize phone to E.164 prior to lookup. [Source: docs/architecture/coding-standards.md#Core-Standards]

- Error Handling & Status Codes:
  - Return 404 when conversation not found; otherwise 200 with metadata and a paginated `items` list; map errors using ApiError envelope where applicable. [Source: docs/architecture/error-handling-strategy.md#Business-Logic-Errors]

- Logging:
  - structlog JSON with `request_id`, `phone`, `result` (found/not_found), and pagination params. [Source: docs/architecture/error-handling-strategy.md#Logging-Standards]

- File Locations (align with structure):
  - `src/api/conversations.py` — router and response models
  - `src/services/conversations.py` — `ConversationService`
  - `src/repositories/conversations.py` — conversation repo additions
  - `src/repositories/messages.py` — message repo with listing
  - `src/utils/phone.py` — reuse normalization helpers
  - `tests/unit/api/test_conversations_route.py`
  - `tests/unit/services/test_conversation_retrieval.py`
  [Source: docs/architecture/project-structure.md#Source-Directories]

- Technical Constraints:
  - Python 3.11; FastAPI; Pydantic; SQLAlchemy async; structlog. Do not perform external HTTP calls here. [Source: docs/architecture/tech-stack.md#Technology-Stack-Table]

### Testing
- Approach: Unit tests for router and service; verify pagination, ordering, normalization, and not-found behavior. [Source: docs/architecture/coding-standards.md#Test-Organization]
- Key Scenarios:
  - Conversation not found → 404
  - Conversation exists, no messages → 200 with empty list
  - Conversation exists with messages → 200 with items ordered desc and pagination metadata
  - Input phone in various formats (raw/E.164/digits-only) resolves to same conversation
- Success Criteria: AC 1–6 met by tests; response schemas stable and typed; logs include request context.

**Change Log**
| Date       | Version | Description           | Author |
|------------|---------|-----------------------|--------|
| 2025-09-26 | 0.1     | Initial draft created | SM     |
| 2025-09-26 | 0.2     | Implemented endpoint, pagination, tests passing | Dev |

**Dev Agent Record**
- Agent Model Used:
  - gpt-4.1-mini (Codex CLI)
- Debug Log References:
  - Reviewed existing route `src/api/conversations.py` and repositories
  - Local pytest runs: all tests passing
- Completion Notes List:
  - Implemented GET `/conversations/{phone_number}` with normalization via `normalize_phone` in service layer
  - Response shape: root-level metadata fields + `messages` list; echoes `page`, `limit`, `offset`, and `total`
  - Added optional support for `offset` to satisfy existing tests while keeping page/limit defaults
  - Repository now provides total count method; service returns `total`
  - Added structlog events for found/not_found outcomes
- File List:
  - src/api/conversations.py (updated)
  - src/services/conversations.py (updated)
  - src/repositories/messages.py (updated)
  - tests/conftest.py (updated)
  - requirements.txt (updated)

**QA Results**
- Gate Decision: PASS
- Summary: Contract now aligns with ACs and coverage is sufficient. API includes `content` (alias of `message_content`) per AC, adds pagination echoes (`page`, `limit`, `offset`, `total`), and binds `request_id` in logs when present. Route tests cover normalization, pagination with ordering, and empty-list behavior; all tests pass locally.
- Acceptance Criteria Traceability:
  - AC1 (metadata): PASS — returns tenant_id (when present), workflow_type, last_message_at
  - AC2 (message fields): PASS — includes direction, content (alias), twilio_sid, delivery_status, created_at; retains internal fields for backward compatibility
  - AC3 (pagination params): PASS — supports page/limit with bounds; optional offset supported and echoed
  - AC4 (404 vs empty list): PASS — 404 when conversation missing; 200 with empty list when no messages
  - AC5 (input normalization): PASS — normalization validated via route test using digits-only input
  - AC6 (tests): PASS — tests assert normalization, ordering desc, pagination metadata, and empty-list scenario
- Risks:
  - Minor: Extra fields (`id`, `from_number`, `to_number`) are present but not harmful; document if part of public contract
  - Observability: Consider middleware to always inject `request_id` for consistent log correlation
- Nice-to-Have:
  - Document response schema in API docs, including any extra fields kept for compatibility
  - Centralize pagination defaults and caps via config
- Evidence:
  - Code: src/api/conversations.py, src/services/conversations.py, src/repositories/messages.py
  - Tests: tests/unit/api/test_conversations_api.py, tests/unit/api/test_conversations_route.py, tests/unit/services/test_conversation_retrieval.py
  - Logs: structlog events bind `request_id` when header present
