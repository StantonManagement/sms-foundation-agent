# <!-- Powered by BMADâ„¢ Core -->
schema: 1
story: "3.3"
story_title: "Retry for Sends"
gate: "PASS" # PASS|CONCERNS|FAIL|WAIVED
status_reason: "Fixes applied: Retry-After now preferred (bounded by cap); outbound failure metric emits labels; unit tests added to assert both behaviors."
reviewer: "Quinn (Test Architect)"
updated: "2025-09-27T02:30:45Z"

waiver: { active: false }

top_issues:
  - id: "RET-002"
    severity: medium
    finding: "429 Retry-After handling uses min(computed_backoff, retry_after_ms, cap), which may retry earlier than provider guidance when Retry-After is larger."
    suggested_action: "Prefer provider hint when present: delay_ms = min(retry_after_ms, cap_ms); optionally apply only for the first retry of 429."
  - id: "OBS-003"
    severity: low
    finding: "outbound_sms_failed counter emitted without labels; acceptance criteria call for labeled metrics."
    suggested_action: "Emit labels (e.g., category=permanent|exhausted, route=/sms/send, status_code, correlation_id if safe). Add a unit assertion."

risk_summary:
  totals: { critical: 0, high: 0, medium: 1, low: 1 }
  recommendations:
    must_fix:
      - "Honor Retry-After when > computed backoff, bounded by cap"
      - "Add labels to outbound failure metric and test"
    monitor:
      - "Observe retry/exhaustion rates post-deploy; adjust attempts/base/cap as needed"
